# azure-pipelines.yml (Versão CORRIGIDA - Alinhada com os Requisitos da Sprint 4)

trigger:
  - main  # 1. Gatilho na branch 'main' (conforme sua verificação)

variables:
  # 2. Configuração do Projeto Java
  JAVA_VERSION: '17'
  PROJECT_SUBDIRECTORY: 'Challenge_Java_2025_Sprint4-main'
  MAVEN_POM_FILE: 'Challenge_Java_2025_Sprint4-main/pom.xml'

  # 3. Configuração do Docker
  DOCKERFILE_PATH: 'Challenge_Java_2025_Sprint4-main/Dockerfile'
  IMAGE_NAME: 'gestaofrota-challenge'

  # 4. Nomes dos Recursos do Azure (do seu script)
  AZURE_WEBAPP_NAME: 'webapp-challenge-945-sprint4'
  AZURE_RESOURCE_GROUP: 'rg-challenge-sprint4'

  # 5. Nomes do ACR (que criamos)
  ACR_LOGIN_SERVER: 'acrchallenge945sprint4.azurecr.io'

  # 6. Nomes das Service Connections (que você criou)
  ACR_SERVICE_CONNECTION: 'connection-acr'
  AZURE_SERVICE_CONNECTION: 'connection-sprint4'

pool:
  vmImage: 'ubuntu-latest'

# --- ESTÁGIOS DA PIPELINE (CI e CD) ---
stages:

  # 7. ESTÁGIO DE CI (Build, Teste e Push da Imagem)
  - stage: CI_Build
    displayName: 'Estágio 1: Build, Teste e Push da Imagem'
    jobs:
      - job: Build
        displayName: 'Build, Test e Docker Push'
        steps:

          # Instala o Java 17
          - task: JavaToolInstaller@0
            displayName: 'Instalar Java $(JAVA_VERSION)'
            inputs:
              versionSpec: '$(JAVA_VERSION)'
              jdkArchitecture: 'x64'
              jdkSourceOption: 'PreInstalled'

          # Roda o Maven (clean, package, tests)
          - task: Maven@3
            displayName: 'Compilar e Testar (Maven)'
            inputs:
              mavenPomFile: '$(MAVEN_POM_FILE)'
              workingDirectory: '$(PROJECT_SUBDIRECTORY)'
              goals: 'clean package'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml' # <--- Cumpre o requisito 7-VI

          # -----------------------------------------------------------------
          # AQUI ESTÁ A CORREÇÃO (Login no ACR)
          # -----------------------------------------------------------------
          - task: Docker@2
            displayName: 'Login no ACR'
            inputs:
              command: 'login'
              # NÃO usamos 'containerRegistry:'
              # Usamos 'azureSubscription' para apontar para a conexão 'azurerm'
              azureSubscription: '$(ACR_SERVICE_CONNECTION)'
              # E 'azureContainerRegistry' para dizer o nome do ACR
              azureContainerRegistry: '$(ACR_LOGIN_SERVER)'

          # -----------------------------------------------------------------
          # AQUI ESTÁ A SEGUNDA CORREÇÃO (Build e Push)
          # -----------------------------------------------------------------
          - task: Docker@2
            displayName: 'Build e Push da Imagem Docker'
            inputs:
              command: 'buildAndPush'
              repository: '$(IMAGE_NAME)'
              dockerfile: '$(DOCKERFILE_PATH)'
              buildContext: '$(PROJECT_SUBDIRECTORY)'
              # NÃO usamos 'containerRegistry:'
              # Usamos 'azureSubscription' novamente
              azureSubscription: '$(ACR_SERVICE_CONNECTION)'
              # E 'azureContainerRegistry' novamente
              azureContainerRegistry: '$(ACR_LOGIN_SERVER)'
              tags: |
                $(Build.BuildId)
                latest

          # Publica o artefato .jar (Boa prática, cumpre requisito 7-V)
          - task: PublishBuildArtifacts@1
            displayName: 'Publicar Artefato (.jar)'
            inputs:
              PathtoPublish: '$(PROJECT_SUBDIRECTORY)/target/*.jar'
              ArtifactName: 'app-jar'
              publishLocation: 'Container'

  # 8. ESTÁGIO DE CD (Deploy no Web App) - Este já estava correto
  - stage: CD_Deploy
    displayName: 'Estágio 2: Deploy no Web App'
    dependsOn: CI_Build
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: 'Deploy no $(AZURE_WEBAPP_NAME)'
        steps:
          - task: AzureWebAppContainer@1
            displayName: 'Deploy Web App Container'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)' # <--- Usa a 'connection-sprint4'
              appName: '$(AZURE_WEBAPP_NAME)'
              resourceGroupName: '$(AZURE_RESOURCE_GROUP)'
              imageName: '$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(Build.BuildId)'
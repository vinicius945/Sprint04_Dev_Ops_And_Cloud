# azure-pipelines.yml (Versão FINAL 5.0 - Correção do 'mavenPomFile' e 'workingDirectory')

trigger:
  - main  # 1. Gatilho na branch 'main'

variables:
  # 2. Configuração do Projeto Java
  JAVA_VERSION: '17'
  PROJECT_SUBDIRECTORY: 'Challenge_Java_2025_Sprint4-main'

  # 3. Configuração do Docker
  DOCKERFILE_PATH: 'Challenge_Java_2025_Sprint4-main/Dockerfile'
  IMAGE_NAME: 'gestaofrota-challenge'

  # 4. Nomes dos Recursos do Azure
  AZURE_WEBAPP_NAME: 'webapp-challenge-945-sprint4'
  AZURE_RESOURCE_GROUP: 'rg-challenge-sprint4'

  # 5. Nomes do ACR
  ACR_LOGIN_SERVER: 'acrchallenge945sprint4.azurecr.io'

  # 6. Nomes das Service Connections
  ACR_SERVICE_CONNECTION: 'connection-acr'       # Conexão do tipo "Docker Registry"
  AZURE_SERVICE_CONNECTION: 'connection-sprint4' # Conexão do tipo "Azure Resource Manager"

pool:
  vmImage: 'ubuntu-latest'

# --- ESTÁGIOS DA PIPELINE (CI e CD) ---
stages:

  # 7. ESTÁGIO DE CI (Build, Teste e Push da Imagem)
  - stage: CI_Build
    displayName: 'Estágio 1: Build, Teste e Push da Imagem'
    jobs:
      - job: Build
        displayName: 'Build, Test e Docker Push'
        steps:

          # Instala o Java 17
          - task: JavaToolInstaller@0
            displayName: 'Instalar Java $(JAVA_VERSION)'
            inputs:
              versionSpec: '$(JAVA_VERSION)'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # Roda o Maven (Com todas as correções)
          - task: Maven@3
            displayName: 'Compilar e Testar (Maven)'
            inputs:
              # Caminho COMPLETO para o pom.xml a partir da raiz
              mavenPomFile: '$(PROJECT_SUBDIRECTORY)/pom.xml' # <-- Caminho correto do pom.xml
              # Diretório onde o Maven deve EXECUTAR
              workingDirectory: '$(PROJECT_SUBDIRECTORY)' # <-- Pasta do projeto
              goals: 'clean package'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
            env: # <-- A SOLUÇÃO: Passa os segredos para os testes
              SPRING_DATASOURCE_URL: $(SPRING_DATASOURCE_URL)
              SPRING_DATASOURCE_USERNAME: $(SPRING_DATASOURCE_USERNAME)
              SPRING_DATASOURCE_PASSWORD: $(SPRING_DATASOURCE_PASSWORD)
              SPRING_DATASOURCE_DRIVER_CLASS_NAME: 'com.microsoft.sqlserver.jdbc.SQLServerDriver'

          # Login no ACR
          - task: Docker@2
            displayName: 'Login no ACR'
            inputs:
              command: 'login'
              containerRegistry: '$(ACR_SERVICE_CONNECTION)'

          # Build e Push da Imagem Docker
          - task: Docker@2
            displayName: 'Build e Push da Imagem Docker'
            inputs:
              command: 'buildAndPush'
              repository: '$(IMAGE_NAME)'
              dockerfile: '$(DOCKERFILE_PATH)'
              buildContext: '$(PROJECT_SUBDIRECTORY)'
              containerRegistry: '$(ACR_SERVICE_CONNECTION)'
              tags: |
                $(Build.BuildId)
                latest

          # Publica o artefato .jar (Este agora vai funcionar)
          - task: PublishBuildArtifacts@1
            displayName: 'Publicar Artefato (.jar)'
            inputs:
              PathtoPublish: '$(PROJECT_SUBDIRECTORY)/target/*.jar' # <-- Este caminho está correto
              ArtifactName: 'app-jar'
              publishLocation: 'Container'

  # 8. ESTÁGIO DE CD (Deploy no Web App)
  - stage: CD_Deploy
    displayName: 'Estágio 2: Deploy no Web App'
    dependsOn: CI_Build
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: 'Deploy no $(AZURE_WEBAPP_NAME)'
        steps:
          - task: AzureWebAppContainer@1
            displayName: 'Deploy Web App Container'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              appName: '$(AZURE_WEBAPP_NAME)'
              resourceGroupName: '$(AZURE_RESOURCE_GROUP)'
              imageName: '$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(Build.BuildId)'